---
title: "Shootings within South Bend School Boundries"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(jsonlite)
library(maptools)
library(ggplot2)
library(tidyr)
library(dplyr)
library(purrr)
library(leaflet)
library(sf)




# city_council <- st_read("City_Council_Districts/City_Council_Districts.shp")
# 
# pol_forc <- st_read("Police_Use_of_Force_Incidents/Police_Use_of_Force_Incidents.shp" )%>%
#   mutate(year=lubridate::year(Date))
# 
# shootings <- st_read("Criminally_Assaulted_Shootings.shp")
# 
# map_df <- shootings %>%
#   select(year = USER_Year, fatal = USER_Fatal) %>%
#   mutate(incident_type = "shooting") %>% 
#   rbind(pol_forc %>% 
#   mutate(year = lubridate::year(Date)) %>%
#   mutate(incident_type = "force") %>% 
#   mutate(fatal = NA) %>%
#   select(year, fatal, incident_type))
# 
# shootings.df <- shootings %>% st_set_geometry(NULL)
# remote_data <- st_join(x = city_council, map_df)
# remote_data.df <- remote_data %>% st_set_geometry(NULL)
# pol_forc.df <- pol_forc  %>% st_set_geometry(NULL)
# 
# save(shootings.df, pol_forc.df, remote_data.df, pol_forc, shootings, remote_data, file="remote_data.rda")
load('remote_data.rda')


pal <- colorNumeric(
  palette = "OrRd",
  domain = 0:40
)


```

Sidebar {.sidebar}
=======================================================================

### <strong>Dashboard Controls<strong>


```{r}



selectInput(inputId = "incident", label = h3("Incident Type"), 
            choices = list("Criminal Shooting" = "shooting", "Police use of Force" = "force"), selected = "shooting")

selectInput(inputId = "year", label = h3("Years"), 
            choices = list("2017" = 2017, "2018" = 2018, "2019" = 2019), selected = 2019)


```


Dashboard
=======================================================================

Row
-----------------------------------------------------------------------

### Criminal Shootings {.value-box}

```{r}

total.shootings <- reactive({
  shootings.df %>% 
    filter(USER_Year == input$year) %>% 
    group_by(USER_Year) %>% 
    summarise(count=n()) %>%
    .$count %>% 
    return()
})


renderValueBox({

  
  valueBox(
    value = total.shootings(),
    #icon = "fa-area-chart",
    #color = if (rate >= input$rateThreshold) "warning" else "primary"
  )
})
```

### Fatal Crimial Fatal {.value-box}

```{r}
total.fatal <- reactive({
  tmp <- shootings.df %>% 
    filter(USER_Year == input$year, USER_Fatal == 'Yes') %>% 
    group_by(USER_Year) %>% 
    summarise(count=n()) %>%
    .$count %>% 
    return()
})


renderValueBox({

  
  valueBox(
    value = paste0(round((total.fatal() / total.shootings())*100,1),"%"),
    #icon = "fa-area-chart",
    #color = if (rate >= input$rateThreshold) "warning" else "primary"
  )
})
```

### Police Incidents {.value-box}

```{r}
Pol_inc <- reactive({
  tmp <- pol_forc.df %>% 
    filter(year == input$year) %>% 
    group_by(year) %>% 
    summarise(count=n()) %>%
    .$count %>% 
    return()
})


renderValueBox({

  
  valueBox(
    value = Pol_inc(),
    #icon = "fa-area-chart",
    #color = if (rate >= input$rateThreshold) "warning" else "primary"
  )
})
```


### Proportion of Police Injurred {.value-box}

```{r}
pol_inj <- reactive({
  tmp <- pol_forc.df %>% 
    filter(year == input$year, Off_Injure =="Yes") %>% 
    group_by(year) %>% 
    summarise(count=n()) %>%
    .$count %>% 
    return()
})


renderValueBox({

  
  valueBox(
    value = paste0(round((pol_inj() / Pol_inc())*100,1),"%"),
    #icon = "fa-area-chart",
    #color = if (rate >= input$rateThreshold) "warning" else "primary"
  )
})
```

Row
-----------------------------------------------------------------------

### Incidents in city Council Boundries {data-width=700}

```{r}
map_reac <- reactive({
  tmp <- remote_data %>% 
    filter(year==input$year, incident_type == input$incident) %>% 
    group_by(Dist, year) %>%
    summarise(count=n()) %>%
    return()
})

renderLeaflet({
  leaflet() %>% 
  addProviderTiles(providers$Stamen.Toner) %>% 
  addPolygons(data=map_reac(), color = ~pal(count), fillOpacity = .5, popup = " Add INFO HEre")
})


```

### Percent of downloads (last 5 min) {data-width=340}

```{r}
tbl_df <- reactive({
  if(input$incident =="shooting"){
    tbl <- shootings.df %>% 
      filter(USER_Year==input$year)
  }else{
    tbl <- pol_forc.df %>% 
      filter(year==input$year)
  }
  return(tbl)
})

renderDataTable({tbl_df()})





```

Current Elected officals
=======================================================================

### Recent Downlads

```{r}

```

